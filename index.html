<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>GluCo</title>

  <link rel="icon" type="image/png" href="imagenes/logoWeb.png">
  <link rel="shortcut icon" type="image/png" href="imagenes/logoWeb.png">
  <link rel="apple-touch-icon" href="imagenes/logoWeb.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.teal-orange.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <link rel="stylesheet" href="style.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">

    <!-- HEADER -->
    <header class="mdl-layout__header">
      <div class="mdl-layout__header-row">

        <div class="mdl-layout-spacer"></div>

        <a class="mdl-layout-title centered-logo" href="#top" id="btnHomeHeader">
          <img src="imagenes/botonImgTitulo.png" style="height:50px;">
        </a>

        <div class="mdl-layout-spacer"></div>

        <!-- Profile circle -->
        <div id="headerControls" style="display:flex;align-items:center;">
          <div id="profileCircle" title="Perfil" style="display:none; cursor:pointer;">
            <span id="profileInitials" style="font-weight:700;color:#333"></span>
          </div>
        </div>

      </div>
    </header>

    <!-- SELECTOR DE PANTALLAS -->
    <div id="selectorPantallas">
      <button id="btnLeft" class="selector-arrow">ü°∏</button>
      <span id="selectorLabel">Principal</span>
      <button id="btnRight" class="selector-arrow">ü°∫</button>
    </div>

    <!-- HOME -->
    <main class="mdl-layout__content" id="homeView">
      <button id="btnOpenScanner" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">
        Escanear C√≥digo de Barras
      </button>

      <!-- --- TABL√ìN / TIMELINE: agregado debajo del bot√≥n --- -->
      <div id="timeline">
        <!-- Area de composici√≥n -->
        <div class="post-box" id="composeBox">
          <div style="display:flex; gap:12px; align-items:flex-start;">
            <div id="composeAvatar" class="avatar-sm">?</div>
            <div style="flex:1; position:relative;">
              <textarea id="composeText" placeholder="¬øQu√© est√°s pensando?" maxlength="1000" disabled></textarea>

              <div id="composeActions" style="display:flex; align-items:center; justify-content:space-between;">
                <div style="font-size:0.85em;color:#666;">M√°x. 1000 caracteres</div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button id="btnOpenAuthFromCompose" class="mdl-button mdl-js-button mdl-button--primary"
                    style="display:none;">Iniciar sesi√≥n</button>
                  <button id="btnPost" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored"
                    disabled>Publicar</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Contenedor de posts -->
        <div id="postsContainer">
          <div style="text-align:center;color:#666;">Cargando posts...</div>
        </div>
      </div>
      <!-- --- fin tabl√≥n --- -->

    </main>

    <!-- PRODUCTOS -->
    <main class="mdl-layout__content" id="vistaProductos" style="display:none;">
      <div class="page-content">

        <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-top:20px;">
          <div class="filterBox">
            <input class="mdl-textfield__input" type="text" id="searchBox"
              placeholder="Buscar por nombre, empresa o c√≥digo...">
          </div>
          <div class="filterBox">
            <select id="catSelect" class="mdl-textfield__input" style="width:180px;">
              <option value="Todas">Todas</option>
            </select>
          </div>
        </div>

        <div id="cardsContainer"></div>

      </div>
    </main>

  </div>

  <!-- MODAL ESC√ÅNER -->
  <div id="scannerModal">
    <div id="scannerBox">
      <h4>Escaneando...</h4>
      <video id="videoScanner" autoplay></video>
      <button id="btnCloseScanner" class="mdl-button mdl-js-button mdl-button--raised">Cerrar</button>
    </div>
  </div>

  <!-- MODAL PRODUCTO DETECTADO -->
  <div id="productoModal">
    <div id="productoBox">
      <button id="closeProducto"
        style="float:right; background:none; border:none; color:white; font-size:20px;">‚úñ</button>
      <div id="productoContent"></div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div id="authModal">
    <div id="authBox">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="authTitle">Iniciar sesi√≥n</h3>
        <button id="closeAuth" style="background:none;border:none;font-size:18px;cursor:pointer">‚úñ</button>
      </div>

      <div class="tabSwitch">
        <button id="tabLogin" class="mdl-button mdl-js-button mdl-button--raised">Login</button>
        <button id="tabRegister" class="mdl-button mdl-js-button">Registrar</button>
      </div>

      <!-- LOGIN -->
      <div id="loginForm">
        <input class="auth-field mdl-textfield__input" type="text" id="loginEmail"
          placeholder="Correo o nombre de usuario">
        <input class="auth-field mdl-textfield__input" type="password" id="loginPass" placeholder="Contrase√±a">
        <button id="btnForgotPassword" class="mdl-button mdl-js-button mdl-button--accent" style="margin-top:10px;">¬øHas
          olvidado tu contrase√±a?</button>
        <div class="auth-actions">
          <button id="doLogin" class="mdl-button mdl-js-button mdl-button--colored mdl-button--raised">Entrar</button>
        </div>
      </div>

      <!-- REGISTER -->
      <div id="registerForm" style="display:none">
        <input class="auth-field mdl-textfield__input" type="email" id="regEmail" placeholder="Correo electr√≥nico">
        <input class="auth-field mdl-textfield__input" type="text" id="regUsername" placeholder="Nombre de usuario">
        <input class="auth-field mdl-textfield__input" type="password" id="regPass1" placeholder="Contrase√±a">
        <input class="auth-field mdl-textfield__input" type="password" id="regPass2" placeholder="Repetir contrase√±a">
        <div class="auth-actions">
          <button id="doRegister"
            class="mdl-button mdl-js-button mdl-button--colored mdl-button--raised">Registrar</button>
        </div>
      </div>

      <div id="authMsg" style="margin-top:8px;color:#a33"></div>
    </div>
  </div>

  <!-- Blocking overlay when not logged -->
  <div id="mustLoginOverlay">Por favor, inicia sesi√≥n para continuar.</div>

  <!-- SCRIPT PRINCIPAL -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc, setDoc,
      addDoc, serverTimestamp, onSnapshot, query, orderBy, deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";


    const firebaseConfig = {
      apiKey: "AIzaSyALHRvYyTQSTytCPZfbYxd8nmQn0-MGRNg",
      authDomain: "productosceliacos-25779.firebaseapp.com",
      projectId: "productosceliacos-25779",
      storageBucket: "productosceliacos-25779.appspot.com",
      messagingSenderId: "499586918138",
      appId: "1:499586918138:web:ca4aa40434bc3e7c144b43",
      measurementId: "G-6YXHT51EXT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const CATS = ["Pan", "Snack", "Bebida", "Pasta", "Pizza", "Dulce", "Cereales", "Pastel", "Reposteria", "Congelado", "Helado", "Cerveza", "Batido", "Embutido", "Salsa"];

    const searchBox = document.getElementById("searchBox");
    const catSelect = document.getElementById("catSelect");
    const cardsTarget = document.getElementById("cardsContainer");

    let productos = [];
    let isLoading = false;

    CATS.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      catSelect.appendChild(opt);
    });

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    async function card(d) {
      let bigImg = `imgProductos/${d.id}.png`;
      let emp = (d.NombreEmpresa || "").toLowerCase().trim();
      emp = emp.normalize("NFD").replace(/[ÃÄ-ÕØ]/g, "");
      emp = emp.replace(/[^a-z0-9]/g, "");
      let smallImg = `imgEmpresas/${emp}.png`;

      return `
      <div class="demo-card-wide mdl-card mdl-shadow--2dp" style="border-radius:14px;overflow:hidden;background:#499273">
        <div class="mdl-card__title" style="height:176px;background-image:url('${bigImg}');background-size:contain;background-position:center;background-repeat:no-repeat;margin:5px;"></div>
        <div style="display:flex;justify-content:center;margin-top:-30px;">
          <img src="${smallImg}" style="width:100px;height:100px;border-radius:50%;border:3px solid white;object-fit:contain;background:#924967;padding:8px;">
        </div>
        <div class="mdl-card__supporting-text" style="display:block;width:100%;text-align:center;background:#AA6C39">
          <strong>${escapeHtml(d.NombreEmpresa || '')}</strong>
          ${d.Nombre ? `<div style="font-size:0.9em;color:black;margin-top:6px;">${escapeHtml(d.Nombre)}</div>` : ``}
          ${d.Ok ? `<div style="font-size:0.85em;color:white;margin-top:8px;">${escapeHtml(d.Ok)}</div>` : ``}
        </div>
      </div>`;
    }

    function render() {
      const q = (searchBox.value || '').toLowerCase().trim();
      const cat = (catSelect.value || 'Todas');

      cardsTarget.innerHTML = "";

      if (isLoading) {
        const p = document.createElement('div');
        p.textContent = "Cargando productos...";
        p.style.gridColumn = '1/-1'; p.style.textAlign = 'center'; p.style.color = '#fff';
        cardsTarget.appendChild(p);
        return;
      }

      if (productos.length === 0) {
        const p = document.createElement('div');
        p.textContent = "No hay productos disponibles.";
        p.style.gridColumn = '1/-1'; p.style.textAlign = 'center'; p.style.color = '#fff';
        cardsTarget.appendChild(p);
        return;
      }

      const results = productos
        .filter(d => (!cat || cat === 'Todas') ? true : (d.tipoProducto === cat))
        .filter(d => {
          if (!q) return true;
          const nombreEmpresa = (d.NombreEmpresa || '').toLowerCase();
          const id = (d.id || '').toLowerCase();
          const tipo = (d.tipoProducto || '').toLowerCase();
          const nombre = (d.Nombre || '').toLowerCase();
          return nombreEmpresa.includes(q) || id.includes(q) || tipo.includes(q) || nombre.includes(q);
        });

      if (results.length === 0) {
        const p = document.createElement('div');
        p.textContent = "No se han encontrado productos para esa b√∫squeda.";
        p.style.gridColumn = '1/-1'; p.style.textAlign = 'center'; p.style.color = '#fff';
        cardsTarget.appendChild(p);
        return;
      }

      (async () => {
        for (const d of results) {
          cardsTarget.insertAdjacentHTML("beforeend", await card(d));
        }
      })();
    }

    async function load() {
      isLoading = true;
      render();
      try {
        const snap = await getDocs(collection(db, "Productos"));
        productos = [];
        snap.forEach(doc => productos.push({ id: doc.id, ...doc.data() }));
      } catch (e) {
        console.error("Error cargando productos:", e);
        productos = [];
      } finally {
        isLoading = false;
        render();
      }
    }

    searchBox.addEventListener("input", render);
    catSelect.addEventListener("change", render);
    load();

    // --- VISTAS ---
    function mostrarProductos() {
      document.getElementById("homeView").style.display = "none";
      document.getElementById("vistaProductos").style.display = "block";
      window.scrollTo(0, 0);
    }

    function mostrarHome() {
      document.getElementById("vistaProductos").style.display = "none";
      document.getElementById("homeView").style.display = "flex";
      window.scrollTo(0, 0);
    }

    document.getElementById("btnHomeHeader").addEventListener("click", e => {
      e.preventDefault();
      vistaActual = "principal";
      selectorLabel.textContent = "Principal";
      mostrarHome();
    });

    const selectorLabel = document.getElementById("selectorLabel");
    const btnLeft = document.getElementById("btnLeft");
    const btnRight = document.getElementById("btnRight");
    let vistaActual = "principal";

    function cambiarVista() {
      if (vistaActual === "principal") {
        mostrarProductos();
        vistaActual = "productos";
        selectorLabel.textContent = "Productos";
      } else {
        mostrarHome();
        vistaActual = "principal";
        selectorLabel.textContent = "Principal";
      }
    }

    btnLeft.addEventListener("click", cambiarVista);
    btnRight.addEventListener("click", cambiarVista);

    // --- ESC√ÅNER ---
    let scanning = false;
    let stream = null;
    const scannerModal = document.getElementById("scannerModal");
    const btnOpenScanner = document.getElementById("btnOpenScanner");
    const btnCloseScanner = document.getElementById("btnCloseScanner");
    const videoScanner = document.getElementById("videoScanner");

    btnOpenScanner.addEventListener("click", async () => {
      scannerModal.style.display = "flex";
      await new Promise(r => setTimeout(r, 300));
      startScanner();
    });

    btnCloseScanner.addEventListener("click", () => stopScanner());

    async function startScanner() {
      scanning = true;

      if (!("BarcodeDetector" in window)) {
        alert("Tu navegador no soporta BarcodeDetector.");
        scannerModal.style.display = "none";
        return;
      }

      let detector;
      try {
        detector = new BarcodeDetector({ formats: ["ean_13", "ean_8", "code_128"] });
      } catch {
        detector = new BarcodeDetector();
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        videoScanner.srcObject = stream;
        await videoScanner.play();
      } catch (error) {
        alert("No se pudo acceder a la c√°mara.");
        scannerModal.style.display = "none";
        return;
      }

      const loop = async () => {
        if (!scanning) return;
        try {
          const codes = await detector.detect(videoScanner);
          if (codes.length > 0) {
            const code = codes[0].rawValue;
            scanning = false;
            stopScanner();
            buscarProducto(code);
            return;
          }
        } catch { }
        requestAnimationFrame(loop);
      };

      requestAnimationFrame(loop);
    }

    function stopScanner() {
      scanning = false;
      scannerModal.style.display = "none";
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      videoScanner.srcObject = null;
    }

    // --- MOSTRAR PRODUCTO ---
    const productoModal = document.getElementById("productoModal");
    const productoContent = document.getElementById("productoContent");

    document.getElementById("closeProducto").addEventListener("click", () => {
      productoModal.style.display = "none";
    });

    async function buscarProducto(id) {
      try {
        const ref = doc(db, "Productos", id);
        const found = await getDoc(ref);

        if (!found.exists()) {
          productoContent.innerHTML = `<h3>No encontrado</h3><p>El c√≥digo ${id} no est√° registrado.</p>`;
          productoModal.style.display = "flex";
          return;
        }

        const d = found.data();
        d.id = id;

        const html = await card(d);
        productoContent.innerHTML = html;
        productoModal.style.display = "flex";

      } catch (e) {
        productoContent.innerHTML = `<h3>Error</h3><p>No se pudo buscar el producto.</p>`;
        productoModal.style.display = "flex";
      }
    }

    // --- AUTH & PROFILE ---
    const authModal = document.getElementById('authModal');
    const closeAuth = document.getElementById('closeAuth');
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const authTitle = document.getElementById('authTitle');
    const authMsg = document.getElementById('authMsg');
    const profileCircle = document.getElementById('profileCircle');
    const profileInitials = document.getElementById('profileInitials');
    const mustLoginOverlay = document.getElementById('mustLoginOverlay');

    function openAuth(defaultTab = 'login') {
      authMsg.textContent = '';
      authModal.style.display = 'flex';
      if (defaultTab === 'login') showLogin(); else showRegister();
    }
    function closeAuthModal() { authModal.style.display = 'none'; }

    closeAuth.addEventListener('click', closeAuthModal);
    tabLogin.addEventListener('click', showLogin);
    tabRegister.addEventListener('click', showRegister);

    function showLogin() { tabLogin.classList.add('mdl-button--raised'); tabRegister.classList.remove('mdl-button--raised'); loginForm.style.display = 'block'; registerForm.style.display = 'none'; authTitle.textContent = 'Iniciar sesi√≥n'; }
    function showRegister() { tabRegister.classList.add('mdl-button--raised'); tabLogin.classList.remove('mdl-button--raised'); loginForm.style.display = 'none'; registerForm.style.display = 'block'; authTitle.textContent = 'Registrar usuario'; }

    // --- REGISTER ---
    async function registerUser() {
      const email = document.getElementById('regEmail').value.trim().toLowerCase();
      const nombre = document.getElementById('regUsername').value.trim();
      const p1 = document.getElementById('regPass1').value;
      const p2 = document.getElementById('regPass2').value;

      if (!email || !nombre || !p1 || !p2) { authMsg.textContent = 'Rellena todos los campos.'; return; }
      if (p1 !== p2) { authMsg.textContent = 'Las contrase√±as no coinciden.'; return; }

      try {
        // Crear usuario en Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, p1);
        // Guardar datos extra en Firestore
        await setDoc(doc(db, 'Usuarios', email), { nombreUsuario: nombre, rango: 'usuario' });
        localStorage.setItem('gluco_currentUser', email);
        closeAuthModal();
        updateUIForUser(email, nombre);
      } catch (e) { console.error(e); authMsg.textContent = 'Error al registrar. ' + (e.message || ''); }
    }

    // --- LOGIN ---
    async function loginUser() {
      const idOrEmail = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      if (!idOrEmail || !pass) { authMsg.textContent = 'Rellena todos los campos.'; return; }

      try {
        let email = idOrEmail;

        try {
          // intentamos login por email
          await signInWithEmailAndPassword(auth, email, pass);
        } catch (err) {
          // si falla, buscamos por nombreUsuario en Firestore
          const usersSnap = await getDocs(collection(db, 'Usuarios'));
          let found = null;
          usersSnap.forEach(d => { if (d.data().nombreUsuario === idOrEmail) found = { id: d.id, ...d.data() }; });
          if (!found) { authMsg.textContent = 'Usuario no encontrado.'; return; }
          email = found.id;
          await signInWithEmailAndPassword(auth, email, pass);
        }

        localStorage.setItem('gluco_currentUser', email);
        closeAuthModal();
        updateUIForUser(email, idOrEmail);
      } catch (e) { console.error(e); authMsg.textContent = 'Error al iniciar sesi√≥n. ' + (e.message || ''); }
    }

    document.getElementById('doRegister').addEventListener('click', registerUser);
    document.getElementById('doLogin').addEventListener('click', loginUser);

    // --- PASSWORD RESET ---
    document.getElementById('btnForgotPassword').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value.trim();
      if (!email) { authMsg.textContent = 'Introduce tu correo para recuperar la contrase√±a.'; return; }
      try {
        await sendPasswordResetEmail(auth, email);
        authMsg.style.color = 'green';
        authMsg.textContent = 'Correo de recuperaci√≥n enviado.';
      } catch (e) { authMsg.style.color = '#a33'; authMsg.textContent = 'Error al enviar correo: ' + (e.message || ''); }
    });

    // --- PROFILE & SESSION ---
    profileCircle.addEventListener('click', () => {
      const cur = localStorage.getItem('gluco_currentUser');
      if (!cur) { openAuth('login'); return; }
      if (confirm('¬øCerrar sesi√≥n?')) {
        localStorage.removeItem('gluco_currentUser');
        auth.signOut();
        updateUIForUser(null);
      }
    });

    // --- NUEVO: TIMELINE / POSTS ---
    const composeText = document.getElementById('composeText');
    const btnPost = document.getElementById('btnPost');
    const postsContainer = document.getElementById('postsContainer');
    const composeAvatar = document.getElementById('composeAvatar');
    const btnOpenAuthFromCompose = document.getElementById('btnOpenAuthFromCompose');

    // Icon mapping seg√∫n rango
    function rankIcon(rango) {
      if (!rango) return '';

      const r = rango.toLowerCase();

      const iconMap = {
        'staff': '<img src="imgRangos/staff.png" class="rank-img">',
        'empresa': '<img src="imgRangos/empresa.png" class="rank-img">',
        'premium': '<img src="imgRangos/premium.png" class="rank-img">',
        'verificado': '<img src="imgRangos/verificado.png" class="rank-img">'
      };

      return iconMap[r] || ''; // si no existe, sin icono
    }

    // Obtener datos de usuario activo
    async function getCurrentUserData() {
      const cur = localStorage.getItem('gluco_currentUser');
      if (!cur) return null;
      try {
        const snap = await getDoc(doc(db, 'Usuarios', cur));
        if (!snap.exists()) return { email: cur, nombreUsuario: cur, rango: 'usuario' };
        const data = snap.data();
        return { email: cur, nombreUsuario: data.nombreUsuario, rango: data.rango || 'usuario' };
      } catch (e) {
        console.error('Error user data', e);
        return { email: cur, nombreUsuario: cur, rango: 'usuario' };
      }
    }

    // Actualiza la UI del header y del compose dependiendo del usuario
    async function updateUIForUser(email, displayName) {
      if (email) {
        profileCircle.style.display = 'flex';
        const initials = (displayName || email).split(' ').map(s => s[0]).slice(0, 2).join('').toUpperCase();
        profileInitials.textContent = initials;
        mustLoginOverlay.style.display = 'none';

        composeText.disabled = false;
        btnPost.disabled = false;
        btnOpenAuthFromCompose.style.display = 'none';

        const ud = await getCurrentUserData();
        const name = ud && ud.nombreUsuario ? ud.nombreUsuario : displayName || email;
        composeAvatar.textContent = (name || email).split(' ').map(s => s[0]).slice(0, 2).join('').toUpperCase();

      } else {
        profileCircle.style.display = 'none';
        mustLoginOverlay.style.display = 'flex';

        composeText.disabled = true;
        btnPost.disabled = true;
        btnOpenAuthFromCompose.style.display = 'inline-block';
        composeAvatar.textContent = '?';
      }

      // ‚ö° Refrescar posts autom√°ticamente
      const snap = await getDocs(query(collection(db, 'Posts'), orderBy('fecha', 'desc')));
      const items = [];
      snap.forEach(d => {
        const data = d.data();
        let fechaVal = null;
        try {
          fechaVal = data.fecha && data.fecha.toDate ? data.fecha.toDate().getTime() : (data.fecha ? new Date(data.fecha).getTime() : null);
        } catch { fechaVal = null; }
        items.push({
          id: d.id,
          autorEmail: data.autorEmail,
          autorNombre: data.autorNombre,
          autorRango: data.autorRango,
          mensaje: data.mensaje,
          fecha: fechaVal
        });
      });
      renderPostsList(items);
    }

    (async () => {
      const cur = localStorage.getItem('gluco_currentUser');
      if (cur) {
        try {
          const snap = await getDoc(doc(db, 'Usuarios', cur));
          if (snap.exists()) updateUIForUser(cur, snap.data().nombreUsuario || cur);
          else updateUIForUser(null);
        } catch (e) { console.error(e); updateUIForUser(null); }
      } else updateUIForUser(null);
      mustLoginOverlay.style.display = localStorage.getItem('gluco_currentUser') ? 'none' : 'flex';
      profileCircle.style.display = 'flex';
    })();

    btnOpenAuthFromCompose.addEventListener('click', () => openAuth('login'));

    // Publicar post
    btnPost.addEventListener('click', async () => {
      const text = (composeText.value || '').trim();
      if (!text) return;
      const cur = localStorage.getItem('gluco_currentUser');
      if (!cur) { openAuth('login'); return; }

      try {
        // Obtener nombre y rango actuales
        const ud = await getCurrentUserData();
        const nombre = ud && ud.nombreUsuario ? ud.nombreUsuario : cur;
        const rango = ud && ud.rango ? ud.rango : 'usuario';

        await addDoc(collection(db, 'Posts'), {
          autorEmail: cur,
          autorUID: auth.currentUser.uid,
          autorNombre: nombre,
          autorRango: rango,
          mensaje: text,
          fecha: serverTimestamp()
        });

        composeText.value = '';
      } catch (e) {
        console.error('Error al publicar post', e);
        alert('No se pudo publicar el post.');
      }
    });

    const staffAlertsContainer = document.createElement('div');
    staffAlertsContainer.id = 'staffAlertsContainer';
    staffAlertsContainer.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 9999;
  `;
    document.body.appendChild(staffAlertsContainer);


    function esMalicioso(texto) {
      if (!texto) return false;
      const patrones = [
        /<script/i,
        /onerror=/i,
        /onload=/i,
        /<iframe/i,
        /<img/i,
        /javascript:/i
      ];
      return patrones.some(p => p.test(texto));
    }


    function mostrarAlertaStaff(usuario, mensaje) {
      const toast = document.createElement('div');
      toast.style.cssText = `
    background: #333;
    color: white;
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    max-width: 250px;
    font-size: 0.9em;
  `;
      toast.textContent = `Contenido sospechoso de ${usuario}`;

      toast.addEventListener('click', () => {
        alert(`Usuario: ${usuario}\nContenido sospechoso:\n${mensaje}`);
      });

      staffAlertsContainer.appendChild(toast);

      setTimeout(() => {
        staffAlertsContainer.removeChild(toast);
      }, 8000);
    }

    // Render posts (simple, seguro y escapando HTML)
    // Render posts (seguro y escapando HTML)
    async function renderPostsList(items) {
      if (!items.length) {
        postsContainer.innerHTML = '<div style="text-align:center;color:#666;">No hay posts a√∫n. S√© el primero.</div>';
        return;
      }

      postsContainer.innerHTML = '';
      const curUserEmail = localStorage.getItem('gluco_currentUser');
      const curUserData = await getCurrentUserData();
      const isStaff = curUserData && curUserData.rango === 'staff';

      for (const p of items) {
        // --- Detectar contenido malicioso ---
        if (esMalicioso(p.mensaje || '')) {
          // Mostrar toast solo al staff
          if (isStaff) {
            mostrarAlertaStaff(p.autorNombre || p.autorEmail, p.mensaje);
          }

          // Borrar autom√°ticamente el post malicioso
          try {
            await deleteDoc(doc(db, 'Posts', p.id));
            continue; // Saltar renderizado de este post
          } catch (e) {
            console.error('Error borrando post malicioso', e);
          }
        }

        const fechaTxt = p.fecha ? new Date(p.fecha).toLocaleString() : '';
        const nombreEsc = escapeHtml(p.autorNombre || p.autorEmail || 'Usuario');
        const mensajeEsc = escapeHtml(p.mensaje || '');
        const initials = (p.autorNombre || p.autorEmail || '').split(' ').map(s => s[0]).slice(0, 2).join('').toUpperCase() || '?';
        const icon = rankIcon(p.autorRango);

        const html = `
      <div class="post-box post-item" style="position:relative;">
        <div class="avatar-sm">${initials}</div>
        <div style="flex:1;">
          <div class="post-meta">
            <strong>${nombreEsc}</strong>
            ${icon ? `<span class="rank-icon" title="${escapeHtml(p.autorRango || '')}">${icon}</span>` : ''}
            <span style="color:#888;font-size:0.85em;margin-left:8px;">${fechaTxt}</span>
          </div>
          <div class="post-text">${mensajeEsc}</div>
        </div>
        <button class="deletePostBtn" style="
          position:absolute;
          bottom:8px;
          right:8px;
          background:none;
          border:none;
          cursor:pointer;
          font-size:18px;
          color:#a33;
        ">üóëÔ∏è</button>
      </div>
    `;
        postsContainer.insertAdjacentHTML('beforeend', html);

        const postEl = postsContainer.lastElementChild;
        const deleteBtn = postEl.querySelector('.deletePostBtn');

        deleteBtn.style.display = 'none';
        if (curUserEmail === p.autorEmail || isStaff) deleteBtn.style.display = 'block';

        deleteBtn.addEventListener('click', async () => {
          if (!confirm('¬øSeguro que quieres borrar este post?')) return;
          try {
            await deleteDoc(doc(db, 'Posts', p.id));
          } catch (e) {
            console.error('Error borrando post', e);
            alert('No se pudo borrar el post.');
          }
        });
      }
    }



    // Escuchar posts en tiempo real (m√°s recientes primero)
    (function listenPostsRealtime() {
      try {
        const q = query(collection(db, 'Posts'), orderBy('fecha', 'desc'));
        onSnapshot(q, snap => {
          const items = [];
          snap.forEach(d => {
            const data = d.data();
            // Manejo: si fecha es Timestamp, convertir a ms
            let fechaVal = null;
            try {
              fechaVal = data.fecha && data.fecha.toDate ? data.fecha.toDate().getTime() : (data.fecha ? new Date(data.fecha).getTime() : null);
            } catch { fechaVal = null; }
            items.push({
              id: d.id,
              autorEmail: data.autorEmail,
              autorNombre: data.autorNombre,
              autorRango: data.autorRango,
              mensaje: data.mensaje,
              fecha: fechaVal
            });
          });
          renderPostsList(items);
        }, err => {
          console.error('Error escuchando posts', err);
          postsContainer.innerHTML = '<div style="text-align:center;color:#a33;">Error cargando posts.</div>';
        });
      } catch (e) {
        console.error('listenPostsRealtime error', e);
        postsContainer.innerHTML = '<div style="text-align:center;color:#a33;">No se pudieron cargar posts.</div>';
      }
    })();

    // --- PROFILE UPDATE bot√≥n cerrar sesi√≥n ya definido antes ---

    // Para seguridad UX: si localStorage cambia (otra pesta√±a), actualizar UI
    window.addEventListener('storage', async (e) => {
      if (e.key === 'gluco_currentUser') {
        const cur = localStorage.getItem('gluco_currentUser');
        if (cur) {
          const snap = await getDoc(doc(db, 'Usuarios', cur));
          updateUIForUser(cur, snap.exists() ? snap.data().nombreUsuario : cur);
        } else updateUIForUser(null);
      }
    });

    mustLoginOverlay.addEventListener('click', () => openAuth('login'));

  </script>

</body>

</html>