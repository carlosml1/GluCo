<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>GluCo</title>

  <link rel="icon" type="image/png" href="imagenes/logoWeb.png">
  <link rel="shortcut icon" type="image/png" href="imagenes/logoWeb.png">
  <link rel="apple-touch-icon" href="imagenes/logoWeb.png">

  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.teal-orange.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <link rel="stylesheet" href="style.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">

    <!-- HEADER -->
    <header class="mdl-layout__header">
      <div class="mdl-layout__header-row">

        <div class="mdl-layout-spacer"></div>

        <a class="mdl-layout-title centered-logo" href="#top" id="btnHomeHeader">
          <img src="imagenes/botonImgTitulo.png" style="height:50px;">
        </a>

        <div class="mdl-layout-spacer"></div>

        <nav class="mdl-navigation mdl-layout--large-screen-only">
          <a class="mdl-navigation__link" href="#" id="btnProductos">Productos</a>
          <a class="mdl-navigation__link" href="#">Escaner</a>
          <a class="mdl-navigation__link" href="#">Tablon</a>
        </nav>
      </div>
    </header>

    <!-- DRAWER -->
    <div class="mdl-layout__drawer">
      <span class="mdl-layout-title">Menú</span>
      <nav class="mdl-navigation">
        <a class="mdl-navigation__link" href="#" id="btnProductos2">Productos</a>
        <a class="mdl-navigation__link" href="#">Escaner</a>
        <a class="mdl-navigation__link" href="#">Tablon</a>
      </nav>
    </div>

    <!-- HOME -->
    <main class="mdl-layout__content" id="homeView"
      style="display:flex; flex-direction:column; gap:20px; align-items:center; justify-content:center; height:100vh;">
      <!-- BOTÓN PARA ABRIR ESCÁNER (visible solo en móvil gracias al CSS externo) -->
      <button id="btnOpenScanner" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">
        Escanear Código de Barras
      </button>
    </main>

    <!-- PRODUCTOS -->
    <main class="mdl-layout__content" id="vistaProductos" style="display:none;">
      <div class="page-content">

        <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-top:20px;">
          <div class="filterBox">
            <input class="mdl-textfield__input" type="text" id="searchBox"
              placeholder="Buscar por nombre, empresa o código...">
          </div>
          <div class="filterBox">
            <select id="catSelect" class="mdl-textfield__input" style="width:180px;">
              <option value="Todas">Todas</option>
            </select>
          </div>
        </div>

        <div id="cardsContainer"
          style="padding:30px; display:grid; grid-template-columns:repeat(auto-fill,minmax(380px,1fr)); gap:30px;">
        </div>

      </div>
    </main>

  </div>

  <!-- MODAL ESCÁNER -->
  <div id="scannerModal">
    <div id="scannerBox">
      <h4>Escaneando...</h4>
      <video id="videoScanner" autoplay></video>
      <button id="btnCloseScanner" class="mdl-button mdl-js-button mdl-button--raised">Cerrar</button>
    </div>
  </div>

  <!-- MODAL PRODUCTO DETECTADO -->
  <div id="productoModal">
    <div id="productoBox">
      <button id="closeProducto"
        style="float:right; background:none; border:none; color:white; font-size:20px;">✖</button>
      <div id="productoContent"></div>
    </div>
  </div>

  <!-- SCRIPT PRINCIPAL -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALHRvYyTQSTytCPZfbYxd8nmQn0-MGRNg",
      authDomain: "productosceliacos-25779.firebaseapp.com",
      projectId: "productosceliacos-25779",
      storageBucket: "productosceliacos-25779.appspot.com",
      messagingSenderId: "499586918138",
      appId: "1:499586918138:web:ca4aa40434bc3e7c144b43",
      measurementId: "G-6YXHT51EXT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const CATS = ["Pan", "Snack", "Bebida", "Pasta", "Pizza", "Dulce", "Cereales", "Pastel", "Reposteria", "Congelado", "Helado", "Cerveza", "Batido", "Embutido", "Salsa"];

    const searchBox = document.getElementById("searchBox");
    const catSelect = document.getElementById("catSelect");
    const cardsTarget = document.getElementById("cardsContainer");

    let productos = [];
    let isLoading = false;

    CATS.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      catSelect.appendChild(opt);
    });

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    async function card(d) {
      let bigImg = `imgProductos/${d.id}.png`;
      let emp = (d.NombreEmpresa || "").toLowerCase().trim();
      emp = emp.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      emp = emp.replace(/[^a-z0-9]/g, "");
      let smallImg = `imgEmpresas/${emp}.png`;

      return `
      <div class="demo-card-wide mdl-card mdl-shadow--2dp" style="border-radius:14px;overflow:hidden;background:#499273">
        <div class="mdl-card__title" style="height:176px;background-image:url('${bigImg}');background-size:contain;background-position:center;background-repeat:no-repeat;margin:5px;"></div>
        <div style="display:flex;justify-content:center;margin-top:-30px;">
          <img src="${smallImg}" style="width:100px;height:100px;border-radius:50%;border:3px solid white;object-fit:contain;background:#924967;padding:8px;">
        </div>
        <div class="mdl-card__supporting-text" style="display:block;width:100%;text-align:center;background:#AA6C39">
          <strong>${escapeHtml(d.NombreEmpresa || '')}</strong>
          ${d.Nombre ? `<div style="font-size:0.9em;color:black;margin-top:6px;">${escapeHtml(d.Nombre)}</div>` : ``}
          ${d.Ok ? `<div style="font-size:0.85em;color:white;margin-top:8px;">${escapeHtml(d.Ok)}</div>` : ``}
        </div>
      </div>`;
    }

    function render() {
      const q = (searchBox.value || '').toLowerCase().trim();
      const cat = (catSelect.value || 'Todas');

      cardsTarget.innerHTML = "";

      if (isLoading) {
        const p = document.createElement('div');
        p.textContent = "Cargando productos...";
        p.style.gridColumn = '1/-1'; p.style.textAlign = 'center'; p.style.color = '#fff';
        cardsTarget.appendChild(p);
        return;
      }

      if (productos.length === 0) {
        const p = document.createElement('div');
        p.textContent = "No hay productos disponibles.";
        p.style.gridColumn = '1/-1'; p.style.textAlign = 'center'; p.style.color = '#fff';
        cardsTarget.appendChild(p);
        return;
      }

      const results = productos
        .filter(d => (!cat || cat === 'Todas') ? true : (d.tipoProducto === cat))
        .filter(d => {
          if (!q) return true;
          const nombreEmpresa = (d.NombreEmpresa || '').toLowerCase();
          const id = (d.id || '').toLowerCase();
          const tipo = (d.tipoProducto || '').toLowerCase();
          const nombre = (d.Nombre || '').toLowerCase();
          return nombreEmpresa.includes(q) || id.includes(q) || tipo.includes(q) || nombre.includes(q);
        });

      if (results.length === 0) {
        const p = document.createElement('div');
        p.textContent = "No se han encontrado productos para esa búsqueda.";
        p.style.gridColumn = '1/-1'; p.style.textAlign = 'center'; p.style.color = '#fff';
        cardsTarget.appendChild(p);
        return;
      }

      (async () => {
        for (const d of results) {
          cardsTarget.insertAdjacentHTML("beforeend", await card(d));
        }
      })();
    }

    async function load() {
      isLoading = true;
      render();
      try {
        const snap = await getDocs(collection(db, "Productos"));
        productos = [];
        snap.forEach(doc => productos.push({ id: doc.id, ...doc.data() }));
      } catch (e) {
        console.error("Error cargando productos:", e);
        productos = [];
      } finally {
        isLoading = false;
        render();
      }
    }

    searchBox.addEventListener("input", render);
    catSelect.addEventListener("change", render);

    load();

    // mostrar productos
    function mostrarProductos() {
      document.getElementById("homeView").style.display = "none";
      document.getElementById("vistaProductos").style.display = "block";
      window.scrollTo(0, 0);
    }

    document.getElementById("btnProductos").addEventListener("click", mostrarProductos);
    document.getElementById("btnProductos2").addEventListener("click", mostrarProductos);

    function mostrarHome() {
      document.getElementById("vistaProductos").style.display = "none";
      document.getElementById("homeView").style.display = "flex";
      window.scrollTo(0, 0);
    }

    document.getElementById("btnHomeHeader").addEventListener("click", e => {
      e.preventDefault(); mostrarHome();
    });

    // ---------- ESCÁNER MODERNO (BarcodeDetector) ----------
    let scanning = false;
    let stream = any;

    const scannerModal = document.getElementById("scannerModal");
    const btnOpenScanner = document.getElementById("btnOpenScanner");
    const btnCloseScanner = document.getElementById("btnCloseScanner");
    const videoScanner = document.getElementById("videoScanner");

    btnOpenScanner.addEventListener("click", async () => {
      scannerModal.style.display = "flex";
      await new Promise(r => setTimeout(r, 300));
      startScanner();
    });

    btnCloseScanner.addEventListener("click", () => stopScanner());

    async function startScanner() {
      scanning = true;

      if (!("BarcodeDetector" in window)) {
        alert("Tu navegador no soporta BarcodeDetector. Usa Chrome/Edge/Firefox en móvil.");
        scannerModal.style.display = "none";
        return;
      }

      let detector;
      try {
        detector = new BarcodeDetector({ formats: ["ean_13", "ean_8", "code_128"] });
      } catch {
        detector = new BarcodeDetector();
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        videoScanner.srcObject = stream;
        await videoScanner.play();
      } catch (error) {
        alert("No se pudo acceder a la cámara. Revisa permisos.");
        scannerModal.style.display = "none";
        return;
      }

      const loop = async () => {
        if (!scanning) return;
        try {
          const codes = await detector.detect(videoScanner);
          if (codes.length > 0) {
            const code = codes[0].rawValue;
            scanning = false;
            stopScanner();
            buscarProducto(code);
            return;
          }
        } catch {}
        requestAnimationFrame(loop);
      };

      requestAnimationFrame(loop);
    }

    function stopScanner() {
      scanning = false;
      scannerModal.style.display = "none";
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      videoScanner.srcObject = null;
    }

    // ---------- MOSTRAR PRODUCTO DETECTADO ----------
    const productoModal = document.getElementById("productoModal");
    const productoContent = document.getElementById("productoContent");
    document.getElementById("closeProducto").addEventListener("click", () => {
      productoModal.style.display = "none";
    });

    async function buscarProducto(id) {
      try {
        const ref = doc(db, "Productos", id);
        const found = await getDoc(ref);

        if (!found.exists()) {
          productoContent.innerHTML = `<h3>No encontrado</h3><p>El código ${id} no está registrado.</p>`;
          productoModal.style.display = "flex";
          return;
        }

        const d = found.data();
        d.id = id;

        const html = await card(d);
        productoContent.innerHTML = html;
        productoModal.style.display = "flex";

      } catch (e) {
        productoContent.innerHTML = `<h3>Error</h3><p>No se pudo buscar el producto.</p>`;
        productoModal.style.display = "flex";
      }
    }

  </script>

</body>

</html>
